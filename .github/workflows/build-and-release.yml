# This workflow will build a package using Maven and then publish a release. It runs daily for snapshot builds if changes were made.
# Beta and Release builds are triggered by creation of tags.

name: Build and Release PiPAA

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  schedule:  # Schedule Daily Build and Release of Snapshot
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:  # Enables manually triggering of workflow for Snapshot Build/Release

permissions:
  contents: write  # Give GITHUB_TOKEN permission to push tags and manage releases.

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    - name: Build with Maven
      run: mvn --batch-mode --update-snapshots clean package
    - name: Rename shaded JAR
      run: mv target/*-shaded.jar target/PiPAA.jar
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PiPAA-artifacts
        path: |
          target/PiPAA.jar
          target/PiPAA.exe

  release: # Only runs daily or when triggered manually.
    needs: build
    runs-on: windows-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Set up Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: PiPAA-artifacts
        path: target/
    - name: Determine tag and check changes
      id: setup
      shell: pwsh
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        $ErrorActionPreference = 'Continue'
        [xml]$xml = Get-Content pom.xml
        $version = $xml.project.version
        $hasChanges = 'true'
        $type = ""
        $tagName = ""
        $releaseBody = ""
        $releaseExists = 'false'
        if ("${{ github.event_name }}" -eq "schedule" -or "${{ github.event_name }}" -eq "workflow_dispatch") {
          $type = "snapshot"
          $tagName = "v$($version -replace '-SNAPSHOT', '')-snapshot"
          $releaseJson = gh release view "$tagName" --json name,body 2>$null
          if ($LASTEXITCODE -eq 0) {
            $release = $releaseJson | ConvertFrom-Json
            $releaseBody = $release.body
            $releaseExists = 'true'
          } else {
            $releaseBody = ""
          }
          $hasChanges = 'true'
          if ("${{ github.event_name }}" -eq "schedule") {
            if ($releaseExists -eq 'true') {
              $oldCommit = git rev-parse "$tagName"
              $log = git log --pretty=oneline "$oldCommit"..HEAD
              if ([string]::IsNullOrEmpty($log)) {
                $hasChanges = 'false'
              }
            } else {
              $hasChanges = 'true'
            }
            if ($hasChanges -eq 'false') {
              Write-Output "No code changes since last snapshot; skipping release."
            }
          }
        } else {
          $tagName = "${{ github.ref_name }}"
          if ($tagName -match '-beta$') {
            $type = "beta"
          } else {
            $type = "release"
          }
          $releaseJson = gh release view "$tagName" --json name,body 2>$null
          if ($LASTEXITCODE -eq 0) {
            $release = $releaseJson | ConvertFrom-Json
            $releaseBody = $release.body
            $releaseExists = 'true'
          } else {
            $releaseBody = ""
          }
          $hasChanges = 'true'
        }
        "has_changes=$hasChanges" >> $env:GITHUB_OUTPUT
        "tag_name=$tagName" >> $env:GITHUB_OUTPUT
        "type=$type" >> $env:GITHUB_OUTPUT
        $cleanVersion = $version -replace '-SNAPSHOT', ''
        "clean_version=$cleanVersion" >> $env:GITHUB_OUTPUT
        $isPrerelease = if ($type -ne "release") { 'true' } else { 'false' }
        "is_prerelease=$isPrerelease" >> $env:GITHUB_OUTPUT
        if ($releaseBody) {
          $encodedBody = [Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes($releaseBody))
          "release_body=$encodedBody" >> $env:GITHUB_OUTPUT
        } else {
          "release_body=" >> $env:GITHUB_OUTPUT
        }
        $LASTEXITCODE = 0
    - name: Create minimized JRE bundle using jlink
      if: steps.setup.outputs.has_changes == 'true'
      shell: pwsh
      run: |
        # Run jdeps to find required modules
        & $env:JAVA_HOME\bin\jdeps.exe --print-module-deps --ignore-missing-deps target\PiPAA.jar | Out-File modules.txt
        $modules = (Get-Content modules.txt -Raw).Trim()
        if ([string]::IsNullOrEmpty($modules)) {
          $modules = "java.base"
        }
        # Remove jre directory if it exists
        if (Test-Path bundle\jre) {
          Remove-Item -Recurse -Force bundle\jre
        }
        # Create custom minimized JRE
        & $env:JAVA_HOME\bin\jlink.exe --add-modules $modules --compress 2 --no-header-files --no-man-pages --strip-debug --output bundle\jre
        # Copy EXE
        Copy-Item target\PiPAA.exe bundle\
        # Zip the bundle
        Compress-Archive -Path bundle\* -DestinationPath target\PiPAA-with-Java.zip
    - name: Update snapshot tag if needed
      if: (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') && steps.setup.outputs.has_changes == 'true'
      shell: pwsh
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        $tagName = "${{ steps.setup.outputs.tag_name }}"
        gh release delete "$tagName" --yes 2>$null
        git push origin :"$tagName" 2>$null
        git tag -f "$tagName" HEAD
        git push origin "$tagName" --force
    - name: Prepare release body
      if: steps.setup.outputs.has_changes == 'true'
      id: body
      shell: pwsh
      run: |
        $body = ""
        if ("${{ steps.setup.outputs.release_body }}") {
          $body = [Text.Encoding]::UTF8.GetString([Convert]::FromBase64String("${{ steps.setup.outputs.release_body }}"))
        } else {
          $body = @"
        This is a snapshot release with the latest changes. It may contain more bugs than the [latest release](https://github.com/mwhitney57/PiPAA/releases/latest). Check the recent [commits](https://github.com/mwhitney57/PiPAA/commits/main/) for more information.
        
        ## ⚙️ Pre-v1.0.0 Reminder
        We have not hit <code>v1.0.0</code> yet. Some things need polish! Please leave an issue on the repository or check the current [Known Issues](https://github.com/mwhitney57/PiPAA?tab=readme-ov-file#-known-issues) if anything is wrong!
        "@
        }
        "body<<EOF" >> $env:GITHUB_OUTPUT
        $body >> $env:GITHUB_OUTPUT
        "EOF" >> $env:GITHUB_OUTPUT
    - name: Create or Update Release
      if: steps.setup.outputs.has_changes == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.setup.outputs.tag_name }}
        name: ${{ steps.setup.outputs.type == 'snapshot' && 'Snapshot' || (steps.setup.outputs.type == 'beta' && 'Beta' || 'Release') }} v${{ steps.setup.outputs.clean_version }}
        body: ${{ steps.body.outputs.body }}
        draft: false
        prerelease: ${{ steps.setup.outputs.is_prerelease }}
        make_latest: ${{ steps.setup.outputs.type == 'release' && 'true' || 'false' }}
        files: |
          target/PiPAA.jar
          target/PiPAA.exe
          target/PiPAA-with-Java.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}